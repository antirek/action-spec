# Задача проекта: Спецификация промпта для классификации намерений пользователя

## Описание задачи

Разработать подход и спецификацию промпта для AI-модели, который позволит классифицировать машиночитаемым способом намерение пользователя из произвольного текстового запроса.

## Основные требования

### Входные данные
- **Произвольный запрос пользователя**: текстовый запрос на естественном языке (может быть дополнен контекстом предыдущих реплик)
- **Список доступных намерений**: предоставляется AI в промпте
- **Формат намерений**: структура уточняется позже, но должна включать:
  - Описание намерения
  - Структуру результата с указанием обязательных и необязательных полей

### Выходные данные
- **Формат результата**: JSON с единой структурой
- **Тип классификации**: одно намерение
- **Поле status**: обязательное поле, указывающее статус результата (`success`, `insufficient_data`, `unknown_intent`)
- **Без вероятности**: результат не содержит информации об уверенности/вероятности

### Функциональные требования
1. Классификация произвольных запросов пользователя по заданному списку намерений
2. Машиночитаемый формат результата (JSON)
3. Обработка неопределенных случаев на двух уровнях:
   - **Дефолтное намерение**: возврат, если намерение не может быть определено (уровень классификации)
   - **Недостаточно данных**: возврат, если намерение определено, но не хватает обязательных параметров (уровень валидации)
4. Поддержка контекста: контекст передается в запросе пользователя (дополненный предыдущими репликами)
5. Валидация данных: в структуре намерения указываются обязательные и необязательные поля результата
6. Логика принятия решения: сначала классификация намерения, затем валидация обязательных параметров

## Уточненные требования

### 1. Формат результата классификации ✅
- ✅ Формат вывода: **JSON**
- ✅ Тип классификации: **одно намерение**
- ✅ Без вероятности: результат не содержит информации об уверенности

### 2. Структура списка намерений ✅
- ✅ JSON массив объектов
- ✅ Каждый объект содержит:
  - `intent` (строка, обязательное): идентификатор намерения
  - `description` (строка, обязательное): описание, как определять намерение из запроса пользователя
  - `examples` (массив строк, опциональное): примеры запросов пользователя для этого намерения
  - `data` (массив объектов, обязательное): описание полей данных намерения
- ✅ Каждый объект в `data` содержит:
  - `field` (строка, обязательное): ключ данных
  - `description` (строка, обязательное): описание, как определять значение поля из запроса пользователя
  - `required` (boolean, обязательное): `true` если поле обязательное, `false` если необязательное
  - `examples` (массив строк, опциональное): примеры значений для этого поля
- ✅ Тип данных AI определяет из описания (явные типы не требуются)
- ✅ Вложенных структур нет (плоская структура данных)
- ✅ Валидация формата на усмотрение AI

### 3. Обработка неопределенных случаев ✅
- ✅ **Дефолтное намерение**: используется, когда запрос пользователя не соответствует ни одному из доступных намерений (не можем определить намерение)
- ✅ **Недостаточно данных**: используется, когда намерение определено, но не хватает обязательных параметров для его выполнения

### 4. Контекст и история ✅
- ✅ Контекст передается в запросе пользователя (дополненный предыдущими репликами)

### 5. Валидация данных ✅
- ✅ В структуре намерения указываются обязательные и необязательные поля результата
- ✅ AI должен валидировать наличие обязательных данных в запросе пользователя

## Статусы результата классификации

Результат запроса к AI всегда содержит поле `status` на верхнем уровне JSON, которое указывает на состояние классификации и валидации данных.

### Возможные статусы

| Статус | Описание | Когда используется | Уровень проблемы |
|--------|----------|-------------------|------------------|
| `success` | Успешная классификация | Намерение определено и все обязательные данные присутствуют | - |
| `insufficient_data` | Недостаточно данных | Намерение определено, но отсутствуют обязательные параметры | Валидация параметров |
| `unknown_intent` | Намерение не определено | Запрос не соответствует ни одному из доступных намерений | Классификация намерения |

### Структура ответа с полем status

Все ответы имеют единую структуру:
```json
{
  "status": "<статус>",
  "intent": "<идентификатор_намерения>",
  "data": { ... }
}
```

### Детальное описание статусов

#### 1. `success`
- **Семантика**: Классификация выполнена успешно, все данные для выполнения намерения присутствуют
- **intent**: Определенное намерение (например, `"send_email"`)
- **data**: Объект с данными намерения согласно его схеме

#### 2. `insufficient_data`
- **Семантика**: Намерение определено, но не хватает обязательных параметров
- **intent**: Определенное намерение (например, `"send_email"`)
- **data**: Объект с информацией о недостающих полях

#### 3. `unknown_intent`
- **Семантика**: Не удалось определить намерение из запроса пользователя
- **intent**: Дефолтное намерение (например, `"default_intent"`)
- **data**: Пустой объект или минимальная информация

## Обработка неопределенных случаев (детальная структура)

Система должна обрабатывать два типа неопределенных случаев, каждый со своей семантикой и структурой ответа.

### 1. Дефолтное намерение (default_intent)

**Когда используется:**
- Запрос пользователя не соответствует ни одному из доступных намерений
- Не удается определить, какое намерение имел в виду пользователь
- Запрос находится вне области действия системы

**Семантика:**
- Уровень проблемы: **классификация намерения**
- Сообщение: "Не могу определить, что вы хотите сделать"

**Структура ответа:**
```json
{
  "status": "unknown_intent",
  "intent": "default_intent",
  "data": {}
}
```

**Примеры запросов:**
- "Как дела?" (при наличии только намерений типа "отправить письмо", "создать задачу")
- "Расскажи анекдот" (не относится к бизнес-логике системы)
- Бессмысленный или неполный запрос, который нельзя интерпретировать

### 2. Недостаточно данных (insufficient_data)

**Когда используется:**
- Намерение успешно определено
- Не хватает обязательных параметров для выполнения намерения
- Требуется дополнительная информация от пользователя

**Семантика:**
- Уровень проблемы: **валидация параметров намерения**
- Сообщение: "Понял, что вы хотите сделать, но не хватает данных"

**Структура ответа:**
```json
{
  "status": "insufficient_data",
  "intent": "send_email",
  "data": {
    "missing_required_fields": ["recipient"],
    "message": "Для отправки письма необходимо указать получателя"
  }
}
```

**Поля структуры:**
- `status` (обязательное): всегда `"insufficient_data"` для этого случая
- `intent` (обязательное): идентификатор определенного намерения (само намерение, не обертка)
- `data.missing_required_fields` (обязательное): массив полей, которых не хватает
- `data.message` (опциональное): человекочитаемое сообщение о том, что требуется

**Примеры запросов:**
- "Отправь письмо" (намерение "send_email" определено, но нет получателя)
- "Создай задачу" (намерение "create_task" определено, но нет названия задачи)
- "Забронируй столик" (намерение "book_table" определено, но нет даты/времени)

### Различия между случаями

| Аспект | Дефолтное намерение | Недостаточно данных |
|--------|---------------------|---------------------|
| **Уровень проблемы** | Классификация намерения | Валидация параметров |
| **Намерение определено?** | Нет | Да |
| **Что известно?** | Ничего | Намерение + частично параметры |
| **Следующее действие** | Уточнить намерение | Запросить недостающие параметры |
| **Статус** | `"unknown_intent"` | `"insufficient_data"` |
| **Поле intent** | `"default_intent"` | Само определенное намерение (например, `"send_email"`) |
| **Структура data** | Пустой объект | Информация о недостающих полях (`missing_required_fields`, `message`) |

### Логика принятия решения

1. **Попытка классификации**: AI пытается сопоставить запрос с доступными намерениями
2. **Если намерение не найдено** → возвращается `status: "unknown_intent"`, `intent: "default_intent"`
3. **Если намерение найдено** → проверяется наличие обязательных полей
4. **Если обязательные поля отсутствуют** → возвращается `status: "insufficient_data"`, определенное намерение и информация о недостающих полях
5. **Если все обязательные поля присутствуют** → возвращается `status: "success"`, намерение и данные

## Структура списка намерений

### Базовая структура

Список намерений представляет собой JSON массив объектов. Каждый объект описывает одно намерение.

**Базовая структура:**
```json
[
  {
    "intent": "<идентификатор_намерения>",
    "description": "<описание_как_определять_намерение>",
    "examples": ["<пример_запроса_1>", "<пример_запроса_2>"],
    "data": [
      {
        "field": "<ключ_данных>",
        "description": "<описание_как_определять_значение>",
        "required": true,
        "examples": ["<пример_значения_1>", "<пример_значения_2>"]
      }
    ]
  }
]
```

**Поля структуры:**
- `intent` (обязательное, строка): уникальный идентификатор намерения
- `description` (обязательное, строка): описание, как определять намерение из запроса пользователя
- `examples` (опциональное, массив строк): примеры запросов пользователя для этого намерения
- `data` (обязательное, массив объектов): описание полей данных намерения
  - `field` (обязательное, строка): ключ данных в результате
  - `description` (обязательное, строка): описание, как определять значение поля из запроса пользователя
  - `required` (обязательное, boolean): `true` если поле обязательное, `false` если необязательное
  - `examples` (опциональное, массив строк): примеры значений для этого поля

### Уточненная структура

**Ответы на вопросы:**
1. ✅ Поле `required: true/false` используется для указания обязательности поля
2. ✅ Тип данных AI определяет из описания (явные типы не требуются)
3. ✅ Примеры нужны: примеры запросов для намерения и примеры значений для полей
4. ✅ Вложенных структур нет (плоская структура данных)
5. ✅ Валидация формата на усмотрение AI (явные правила не требуются)
6. ✅ Описание одно (не нужны множественные описания)

### Финальная структура

```json
[
  {
    "intent": "send_email",
    "description": "Пользователь хочет отправить электронное письмо",
    "examples": [
      "Отправь письмо на адрес user@example.com",
      "Напиши письмо с темой 'Встреча'",
      "Отправь email"
    ],
    "data": [
      {
        "field": "recipient",
        "description": "Email адрес получателя письма",
        "required": true,
        "examples": ["user@example.com", "admin@company.com"]
      },
      {
        "field": "subject",
        "description": "Тема письма",
        "required": true,
        "examples": ["Встреча", "Важное сообщение", "Отчет"]
      },
      {
        "field": "body",
        "description": "Текст письма",
        "required": false,
        "examples": ["Здравствуйте, хочу обсудить проект", "Привет, как дела?"]
      }
    ]
  }
]
```

## Структура спецификации

Спецификация должна включать:

1. **Структура промпта**
   - Системный промпт с инструкциями для классификации
   - Формат описания намерений (JSON массив объектов с полями intent, description, data)
   - Четкие правила обработки двух типов неопределенных случаев:
     - Дефолтное намерение (когда намерение не определено)
     - Недостаточно данных (когда намерение определено, но не хватает параметров)
   - Примеры использования для каждого случая

2. **Формат входных данных**
   - Структура списка намерений:
     - JSON массив объектов
     - Каждый объект: `intent` (строка), `description` (строка), `examples` (массив строк, опционально), `data` (массив объектов)
     - Каждый объект в `data`: `field` (строка), `description` (строка), `required` (boolean), `examples` (массив строк, опционально)
     - Тип данных определяется AI из описания
     - Плоская структура данных (вложенных структур нет)
   - Формат запроса пользователя (с возможностью включения контекста)
   - Определение дефолтного намерения в списке намерений

3. **Формат выходных данных**
   - Единая JSON структура результата классификации:
     - Поле `status` (обязательное): статус результата (`success`, `insufficient_data`, `unknown_intent`)
     - Поле `intent` (обязательное): идентификатор намерения
     - Поле `data` (обязательное): данные намерения или информация об ошибке
   - Структура ответа для каждого статуса:
     - `success`: намерение и полные данные
     - `insufficient_data`: намерение и информация о недостающих полях
     - `unknown_intent`: дефолтное намерение и пустой data
   - Примеры валидных JSON ответов для всех статусов

4. **Валидация данных**
   - Правила валидации обязательных полей
   - Логика принятия решения: классификация → валидация параметров
   - Обработка неполных данных (намерение "недостаточно данных")
   - Примеры валидации для разных сценариев

5. **Рекомендации по использованию**
   - Best practices для формирования промпта
   - Как передавать контекст в запросе пользователя
   - Ограничения и известные проблемы
   - Примеры промптов для разных сценариев

## Следующие шаги

1. ✅ Определить формат результата (JSON, одно намерение, без вероятности)
2. ✅ Определить обработку неопределенных случаев (дефолтное намерение)
3. ✅ Определить подход к контексту (передача в запросе пользователя)
4. ✅ Определить валидацию данных (обязательные/необязательные поля)
5. ✅ Определить полную структуру списка намерений (JSON массив с полями intent, description, examples, data; каждое поле в data имеет field, description, required, examples)
6. Разработать структуру спецификации промпта
7. Создать примеры промптов с разными сценариями
8. Протестировать подход на реальных данных

## Примеры структур (предварительные)

### Пример структуры намерения в списке намерений
```json
{
  "intent": "send_email",
  "description": "Пользователь хочет отправить электронное письмо",
  "examples": [
    "Отправь письмо на адрес user@example.com",
    "Напиши письмо с темой 'Встреча'",
    "Отправь email"
  ],
  "data": [
    {
      "field": "recipient",
      "description": "Email адрес получателя письма",
      "required": true,
      "examples": ["user@example.com", "admin@company.com"]
    },
    {
      "field": "subject",
      "description": "Тема письма",
      "required": true,
      "examples": ["Встреча", "Важное сообщение", "Отчет"]
    },
    {
      "field": "body",
      "description": "Текст письма",
      "required": false,
      "examples": ["Здравствуйте, хочу обсудить проект", "Привет, как дела?"]
    }
  ]
}
```

### Пример результата успешной классификации (status: success)
```json
{
  "status": "success",
  "intent": "send_email",
  "data": {
    "recipient": "user@example.com",
    "subject": "Важное сообщение",
    "body": "Текст письма"
  }
}
```

### Пример результата "недостаточно данных" (status: insufficient_data)
```json
{
  "status": "insufficient_data",
  "intent": "send_email",
  "data": {
    "missing_required_fields": ["recipient"],
    "message": "Для отправки письма необходимо указать получателя"
  }
}
```

### Пример результата с неопределенным намерением (status: unknown_intent)
```json
{
  "status": "unknown_intent",
  "intent": "default_intent",
  "data": {}
}
```

**Примечание:** Детальное описание обоих случаев см. в разделе "Обработка неопределенных случаев (детальная структура)"

## Примечания

- Спецификация должна быть достаточно гибкой для различных применений
- Формат должен быть понятным как для AI, так и для разработчиков
- Необходимо обеспечить воспроизводимость результатов
- Контекст диалога передается путем дополнения запроса пользователя предыдущими репликами

